<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:">
  <title>Scanner QR - Feuille de Temps</title>
  
  <!-- Chargement de la biblioth√®que QR scanner avec plusieurs CDN de secours -->
  <script>
    // Fonction pour charger la biblioth√®que depuis un CDN
    function loadQRScannerLibrary(cdnUrl, onSuccess, onError) {
      const script = document.createElement('script');
      script.src = cdnUrl;
      script.crossOrigin = 'anonymous';
      
      script.onload = function() {
        console.log('‚úÖ Biblioth√®que charg√©e depuis:', cdnUrl);
        onSuccess();
      };
      
      script.onerror = function() {
        console.log('‚ùå √âchec de chargement depuis:', cdnUrl);
        onError();
      };
      
      document.head.appendChild(script);
    }

    // Liste des CDN √† essayer
    const cdnUrls = [
      'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js',
      'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js',
      'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/html5-qrcode.min.js',
      'https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js'
    ];

    let currentCdnIndex = 0;

    function tryNextCDN() {
      if (currentCdnIndex < cdnUrls.length) {
        const cdnUrl = cdnUrls[currentCdnIndex];
        console.log(`üîÑ Tentative de chargement depuis: ${cdnUrl}`);
        
        loadQRScannerLibrary(
          cdnUrl,
          function() {
            // Succ√®s - la biblioth√®que est charg√©e
            if (typeof Html5QrcodeScanner !== 'undefined') {
              console.log('‚úÖ Biblioth√®que QR scanner charg√©e avec succ√®s');
              // D√©clencher l'√©v√©nement de chargement
              window.dispatchEvent(new Event('qrLibraryLoaded'));
            } else {
              console.log('‚ö†Ô∏è Script charg√© mais Html5QrcodeScanner non d√©fini');
              tryNextCDN();
            }
          },
          function() {
            // √âchec - essayer le prochain CDN
            currentCdnIndex++;
            tryNextCDN();
          }
        );
        
        currentCdnIndex++;
      } else {
        console.error('‚ùå Tous les CDN ont √©chou√©');
        window.dispatchEvent(new Event('qrLibraryLoadFailed'));
      }
    }

    // D√©marrer le chargement
    tryNextCDN();
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 100%;
      text-align: center;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #666;
    }

    .btn-logout {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-logout:hover {
      background: #c82333;
      transform: translateY(-1px);
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 600;
    }

    .status {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .timesheet-form {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-success:hover {
      background: #218838;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .timesheet-history {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
    }

    .history-item {
      padding: 8px;
      border-bottom: 1px solid #e1e5e9;
      font-size: 12px;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    @media (max-width: 480px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 20px;
      }

      .header {
        flex-direction: column;
        gap: 10px;
      }

      .user-info {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Scanner QR - Feuille de Temps</h1>
      <div class="user-info" id="userInfo" style="display: none;">
        <span id="userName"></span>
        <button class="btn-logout" onclick="logout()">üö™ D√©connexion</button>
      </div>
    </div>
    
    <div class="status" id="status">
      <strong>√âtat :</strong> <span id="statusText">Initialisation...</span>
    </div>

    <div id="reader"></div>
    
    <div class="timesheet-form" id="timesheetForm" style="display: none;">
      <h3>üìù Enregistrer une feuille de temps</h3>
      
      <div class="form-group">
        <label for="timesheetType">Type de feuille de temps</label>
        <select id="timesheetType" required>
          <option value="">S√©lectionner un type</option>
          <option value="1">Entr√©e</option>
          <option value="2">Sortie</option>
          <option value="3">Pause</option>
          <option value="4">Reprise</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="site">Site</label>
        <select id="site" required>
          <option value="">S√©lectionner un site</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="notes">Notes (optionnel)</label>
        <input type="text" id="notes" placeholder="Description de l'activit√©">
      </div>
      
      <button class="btn btn-success" onclick="submitTimesheet()">
        ‚úÖ Enregistrer la feuille de temps
      </button>
    </div>

    <div id="result" style="display: none;">
      <div class="result-text">
        <strong>QR Code scann√© :</strong> <span id="output"></span>
      </div>
      <button class="btn" onclick="resetScanner()">Scanner un autre QR code</button>
    </div>

    <button class="btn" id="startBtn" onclick="startScanner()" style="display: none;">
      D√©marrer le scanner
    </button>
    
    <button class="btn" onclick="loadTimesheetHistory()" style="background: #6c757d; margin-top: 10px;">
      üìã Historique des feuilles de temps
    </button>

    <div id="historyContainer" style="display: none;">
      <h3>üìã Historique r√©cent</h3>
      <div class="timesheet-history" id="timesheetHistory"></div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    let html5QrcodeScanner = null;
    let isScanning = false;
    let authManager = new AuthManager();
    let sites = [];
    let currentQRData = null;

    // V√©rifier si on est en HTTPS
    function checkHTTPS() {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        document.getElementById('statusText').textContent = '‚ö†Ô∏è HTTPS requis pour la cam√©ra';
        document.getElementById('status').classList.add('error');
        return false;
      }
      return true;
    }

    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      const statusTextEl = document.getElementById('statusText');
      
      statusTextEl.textContent = message;
      statusEl.className = 'status';
      
      if (type === 'error') {
        statusEl.classList.add('error');
      } else if (type === 'success') {
        statusEl.classList.add('success');
      } else if (type === 'info') {
        statusEl.classList.add('info');
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (!isScanning) return;
      
      isScanning = false;
      currentQRData = decodedText;
      document.getElementById('output').textContent = decodedText;
      document.getElementById('result').style.display = 'block';
      document.getElementById('timesheetForm').style.display = 'block';
      
      updateStatus('‚úÖ QR code d√©tect√© ! Remplissez les informations ci-dessous.', 'success');
      
      // Arr√™ter la cam√©ra
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
      }
    }

    function onScanError(error) {
      console.log('Scan error:', error);
    }

    function startScanner() {
      if (!checkHTTPS()) {
        return;
      }

      if (typeof Html5QrcodeScanner === 'undefined') {
        updateStatus('‚ùå Erreur: Biblioth√®que QR scanner non charg√©e. Rechargez la page.', 'error');
        return;
      }

      updateStatus('üîÑ D√©marrage de la cam√©ra...');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        updateStatus('‚ùå Votre navigateur ne supporte pas l\'acc√®s √† la cam√©ra', 'error');
        return;
      }

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
          };

          html5QrcodeScanner = new Html5QrcodeScanner(
            "reader",
            config,
            false
          );

          html5QrcodeScanner.render(onScanSuccess, onScanError);
          
          isScanning = true;
          updateStatus('üì± Cam√©ra active - Pointez vers un QR code', 'info');
          document.getElementById('startBtn').style.display = 'none';
        })
        .catch(function(error) {
          console.error('Erreur cam√©ra:', error);
          let errorMessage = '‚ùå Erreur d\'acc√®s √† la cam√©ra';
          
          if (error.name === 'NotAllowedError') {
            errorMessage = '‚ùå Permission cam√©ra refus√©e. Cliquez sur l\'ic√¥ne cam√©ra dans la barre d\'adresse.';
          } else if (error.name === 'NotFoundError') {
            errorMessage = '‚ùå Aucune cam√©ra trouv√©e sur cet appareil.';
          } else if (error.name === 'NotSupportedError') {
            errorMessage = '‚ùå Votre navigateur ne supporte pas l\'acc√®s √† la cam√©ra.';
          }
          
          updateStatus(errorMessage, 'error');
          document.getElementById('startBtn').style.display = 'block';
        });
    }

    function resetScanner() {
      document.getElementById('result').style.display = 'none';
      document.getElementById('timesheetForm').style.display = 'none';
      document.getElementById('output').textContent = '';
      document.getElementById('startBtn').style.display = 'block';
      updateStatus('Pr√™t √† scanner');
      isScanning = false;
      currentQRData = null;
    }

    // Charger les sites disponibles
    async function loadSites() {
      try {
        const response = await authManager.authenticatedRequest(`${authManager.API_BASE_URL}/Site`);
        if (response.ok) {
          sites = await response.json();
          const siteSelect = document.getElementById('site');
          siteSelect.innerHTML = '<option value="">S√©lectionner un site</option>';
          
          sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = site.name || site.description || `Site ${site.id}`;
            siteSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Erreur chargement sites:', error);
      }
    }

    // Soumettre une feuille de temps
    async function submitTimesheet() {
      const timesheetType = document.getElementById('timesheetType').value;
      const siteId = document.getElementById('site').value;
      const notes = document.getElementById('notes').value;

      if (!timesheetType || !siteId) {
        updateStatus('‚ùå Veuillez remplir tous les champs obligatoires.', 'error');
        return;
      }

      try {
        updateStatus('üîÑ Enregistrement de la feuille de temps...', 'info');

        const timesheetData = {
          userId: authManager.getUser().id,
          timesheetTypeId: parseInt(timesheetType),
          siteId: parseInt(siteId),
          notes: notes,
          qrCodeData: currentQRData,
          timestamp: new Date().toISOString()
        };

        const response = await authManager.createTimesheet(timesheetData);
        
        updateStatus('‚úÖ Feuille de temps enregistr√©e avec succ√®s !', 'success');
        
        // Recharger l'historique
        await loadTimesheetHistory();
        
        // R√©initialiser le formulaire
        setTimeout(() => {
          resetScanner();
        }, 2000);
        
      } catch (error) {
        console.error('Erreur enregistrement feuille de temps:', error);
        updateStatus('‚ùå Erreur lors de l\'enregistrement. V√©rifiez votre connexion.', 'error');
      }
    }

    // Charger l'historique des feuilles de temps
    async function loadTimesheetHistory() {
      try {
        const user = authManager.getUser();
        const response = await authManager.getUserTimesheets(user.id, 'daily');
        
        if (response && response.length > 0) {
          const historyContainer = document.getElementById('historyContainer');
          const historyDiv = document.getElementById('timesheetHistory');
          
          historyDiv.innerHTML = '';
          
          response.slice(0, 10).forEach(timesheet => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
              <strong>${new Date(timesheet.timestamp).toLocaleString()}</strong><br>
              Type: ${timesheet.timesheetTypeName || 'N/A'} | 
              Site: ${timesheet.siteName || 'N/A'}
              ${timesheet.notes ? `<br>Notes: ${timesheet.notes}` : ''}
            `;
            historyDiv.appendChild(item);
          });
          
          historyContainer.style.display = 'block';
        }
      } catch (error) {
        console.error('Erreur chargement historique:', error);
      }
    }

    // Fonction de d√©connexion
    function logout() {
      authManager.logout();
    }

    // Afficher les informations utilisateur
    function displayUserInfo() {
      const user = authManager.getUser();
      if (user) {
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        userName.textContent = `üë§ ${user.username || user.name || 'Utilisateur'}`;
        userInfo.style.display = 'flex';
      }
    }

    // V√©rifier l'authentification
    async function checkAuthentication() {
      if (!authManager.isAuthenticated()) {
        window.location.href = 'login.html';
        return false;
      }

      try {
        const isValid = await authManager.validateToken();
        if (!isValid) {
          authManager.logout();
          return false;
        }
        return true;
      } catch (error) {
        console.error('Erreur v√©rification authentification:', error);
        authManager.logout();
        return false;
      }
    }

    // Initialisation
    window.addEventListener('load', async function() {
      console.log('üîÑ Page charg√©e, v√©rification de l\'authentification...');
      
      const isAuthenticated = await checkAuthentication();
      if (!isAuthenticated) {
        return;
      }

      displayUserInfo();
      await loadSites();
      
      console.log('üîÑ Attente de la biblioth√®que QR scanner...');
    });

    // √âcouter l'√©v√©nement de chargement r√©ussi de la biblioth√®que
    window.addEventListener('qrLibraryLoaded', function() {
      console.log('‚úÖ √âv√©nement qrLibraryLoaded re√ßu');
      if (checkHTTPS()) {
        updateStatus('Pr√™t √† scanner des QR codes pour les feuilles de temps');
        document.getElementById('startBtn').style.display = 'block';
      }
    });

    // √âcouter l'√©v√©nement d'√©chec de chargement de la biblioth√®que
    window.addEventListener('qrLibraryLoadFailed', function() {
      console.error('‚ùå √âv√©nement qrLibraryLoadFailed re√ßu');
      updateStatus('‚ùå Erreur: Impossible de charger la biblioth√®que QR scanner. V√©rifiez votre connexion internet et rechargez la page.', 'error');
    });
  </script>
</body>
</html>
